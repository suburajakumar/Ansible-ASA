---
- name: Get Cisco ASA version without collection modules
  hosts: cisco_asa
  gather_facts: false
  connection: network_cli 

  tasks:
    - name: 1. Execute 'show version' command
      ansible.builtin.cli_command:
        command: show version
      register: version_output

    - name: 2. Extract and Set ASA Version (Ultimate Standard Fix)
      ansible.builtin.set_fact:
        asa_version_string: >
          {# Define marker and convert entire output to lowercase for a safe search #}
          {% set start_marker = 'software version' %}
          {% set raw_output_lower = version_output.stdout[0] | lower %}
          
          {# Find the correct line in the output #}
          {% set line = raw_output_lower.split('\n') 
                        | select('search', start_marker) 
                        | list 
                        | default([]) 
                        | first %}

          {% if line %}
          {# Find the position after the marker #}
          {% set version_start_index = line.find(start_marker) + start_marker | length %}
          
          {# Slice the string, split by space, grab the first element #}
          {{ line[version_start_index:] | split(' ') 
             | select('length') | first | trim }}
          {% else %}
          N/A_UNMATCHED
          {% endif %}

    - name: 3. Display the ASA version
      ansible.builtin.debug:
        msg: "ASA Software Version on {{ inventory_hostname }}: {{ asa_version_string }}"